<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Gomoku Game</title>
    <style>  
        table {
            border-collapse: collapse;
            margin: 20px auto;
        }

        td {
            width: 40px;  
            height: 40px; 
            position: relative; /* Allow absolute positioning of child elements */
            padding: 0;  
            border: none; /* Hide borders of the cells */
        }

        /* Grid lines */
        td::before, td::after {
            content: "";
            position: absolute;
            background: black;
        }

        /* Horizontal line */
        td::before {
            width: 100%;
            height: 2px;
            top: 50%;
            left: 0;
            transform: translateY(-50%);
        }

        /* Vertical line */
        td::after {
            width: 2px;
            height: 100%;
            left: 50%;
            top: 0;
            transform: translateX(-50%);
        }

        .black-dot {
            font-size: 36px;
            color: black;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none; /* Prevent interaction */
        }

        .white-dot {
            font-size: 36px;
            color: white;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none; /* Prevent interaction */
            text-shadow: 
                -1px -1px 0 black,
                1px -1px 0 black,
                -1px 1px 0 black,
                1px 1px 0 black;
        }

        h1 {
            text-transform: uppercase;
        }

        #main-menu {
            text-decoration: underline;
            cursor: pointer;
            color: blue;
            font-size: 21px;
        }

    </style>
</head>
<body>
    <h1>Gomoku Game {{mode}} {{variant}} </h1>

    <div>
        Player 1 captures <span id="p1_captures">0</span>
    </div>

    <div>
        Player 2 captures <span id="p2_captures">0</span>
    </div>
    
    <table id="board">
        {% for y in range(board_size) %}
        <tr>
            {% for x in range(board_size) %}
            <td data-x="{{ x }}" data-y="{{ y }}">
                {% if board[y][x] == 0 %}
                    &nbsp; 
                {% elif board[y][x] == 1 %}
                    <span class="black-dot">&#9679;</span>
                {% elif board[y][x] == 2 %}
                    <span class="white-dot">&#9675;</span>
                {% endif %}
            </td>
            {% endfor %}
        </tr>
        {% endfor %}
    </table>    

    <div id="main-menu">
        Main menu
    </div>

    <script>

        // Table cell click
        document.querySelectorAll('td').forEach(cell => {
            cell.addEventListener('click', function() {
                const x = this.getAttribute('data-x');
                const y = this.getAttribute('data-y');

                fetch('/move', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `x=${x}&y=${y}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status) { 
                        updateGameBoard(); 
                    } else {
                        console.log("Invalid move or game over.");
                    }
                })
                .catch(error => console.error('Error:', error));
            });
        });

        // Retrieve data from backend to update rendered board
        function updateGameBoard() {
            fetch('/board')
                .then(response => response.json())
                .then(data => {
                    const board = data.board;
                    const p1_captures = data.p1_captures
                    const p2_captures = data.p2_captures
                    const is_end = data.is_end

                    if (is_end != 0)
                    {
                        alert("GAME OVER: PLAYER " + is_end + " WON")
                        reset_and_redirect()
                        return
                    }

                    // set capture count
                    document.getElementById("p1_captures").textContent = p1_captures
                    document.getElementById("p2_captures").textContent = p2_captures

                    const cells = document.querySelectorAll('#board td');
                    cells.forEach(cell => {
                        const x = parseInt(cell.getAttribute('data-x')); // 0-based index for x
                        const y = parseInt(cell.getAttribute('data-y')); // 0-based index for y
                        updateCell(cell, board[y][x]);
                    });
                })
                .catch(error => console.error('Error fetching board:', error));
        }

        // Helper fnction to update board cell
        function updateCell(cell, value) {
            if (value == 0) {
                cell.innerHTML = '&nbsp;';
            } else if (value == 1) {
                cell.innerHTML = '<span class="black-dot">&#9679;</span>';
            } else if (value == 2) {
                cell.innerHTML = '<span class="white-dot">&#9675;</span>';
            }
        }

        // Reset state in backend and redirects to root endpoint
        function reset_and_redirect() {
            fetch('/reset', {
                method: 'POST',
            })
            .then(response => response.json())
            .then(data => {
                window.location.href = "/"
            })
            .catch(error => {
                alert("POST /reset error")
                console.error('Error reset board:', error);
            });
        }

        document.getElementById('main-menu').addEventListener('click', () => reset_and_redirect())
    </script>
</body>
</html>
